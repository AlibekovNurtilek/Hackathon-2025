name: Deploy FastAPI with Docker

on:
  push:
    branches:
      - main  # –ê–≤—Ç–æ-–¥–µ–ø–ª–æ–π –ø—Ä–∏ –ø—É—à–µ –≤ main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy to Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}
          SERVER_USER: g2004_01013
          SERVER_IP: 35.238.178.114
          APP_DIR: /home/g2004_01013/Hackathon-2025
          REPO_URL: https://github.com/AlibekovNurtilek/Hackathon-2025.git
        run: |
          echo "üîë –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH-–∫–ª—é—á..."
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          echo "üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π..."
          ssh -i private_key.pem -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP /bin/bash << 'EOF'
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ

            echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
            cd $APP_DIR

            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ..."
            git fetch origin main
            if git diff --quiet HEAD origin/main; then
              echo "‚úÖ –ö–æ–¥ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è. –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä."
              docker-compose restart fastapi
              exit 0
            else
              echo "üîÑ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω. –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
              git pull origin main --rebase || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ git pull, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
            fi

            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            if git diff --quiet HEAD@{1} HEAD environment.yml; then
              echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ."
              docker-compose up -d
            else
              echo "üõ†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö! –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
              docker-compose down
              docker-compose up -d --build
            fi

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          EOF
          
          echo "üßπ –£–¥–∞–ª—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á..."
          rm -f private_key.pem
