name: Deploy FastAPI with Docker

on:
  push:
    branches:
      - main  # –ê–≤—Ç–æ-–¥–µ–ø–ª–æ–π –ø—Ä–∏ –ø—É—à–µ –≤ main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy to Server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}
          SERVER_USER: g2004_01013
          SERVER_IP: 35.238.178.114
          APP_DIR: /home/g2004_01013/Hackathon-2025
          REPO_URL: https://github.com/AlibekovNurtilek/Hackathon-2025.git  # –£–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        run: |
          echo "üîë –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH-–∫–ª—é—á..."
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          echo "üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π..."
          ssh -i private_key.pem -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP /bin/bash << EOF
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ

            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Ç—å..."
            pwd
            ls -la
            
            echo "üìÇ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "‚ö†Ô∏è –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –ö–ª–æ–Ω–∏—Ä—É–µ–º..."
              rm -rf $APP_DIR
              git clone $REPO_URL $APP_DIR
            else
              echo "‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥..."
              cd $APP_DIR
              git reset --hard  # –û—á–∏—â–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
              git pull origin main --rebase || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ git pull, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
            fi

            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ environment.yml..."
            if git diff --quiet HEAD@{1} HEAD environment.yml; then
              echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º..."
              docker-compose up -d --force-recreate --no-deps --build fastapi
            else
              echo "üõ†Ô∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å! –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
              docker-compose down
              docker-compose up -d --build
            fi

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          EOF
          
          echo "üßπ –£–¥–∞–ª—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á..."
          rm -f private_key.pem
